#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

DIR_ENDPOINT="http://127.0.0.1:4000"
DIR_PUBLIC_KEY="OnF3Jh7tZ4o3g3bmUdgjTDa4qlMHN-2Q4RrJQD6K124"
SERVER_NAME="~demo01"
USERNAME="@demo01"

STATE_DIR="$ROOT/demo/state"
USERNAME_KEYS="$STATE_DIR/username-owner.json"
DEVICE_SECRET="$STATE_DIR/device-secret.bcs"
DEVICE_CHAIN="$STATE_DIR/device-chain.bcs"

cd "$ROOT"
mkdir -p "$STATE_DIR"

MULTITOOL=(cargo run -p nullspace-multitool --)
DIR_ARGS=(--endpoint "$DIR_ENDPOINT" --public-key "$DIR_PUBLIC_KEY")

if [[ ! -f "$USERNAME_KEYS" ]]; then
  "${MULTITOOL[@]}" keygen > "$USERNAME_KEYS"
fi

SIGNING_PUBLIC="$(jq -r '.signing.public' "$USERNAME_KEYS")"
SIGNING_SECRET="$(jq -r '.signing.secret' "$USERNAME_KEYS")"

if [[ -z "$SIGNING_PUBLIC" || "$SIGNING_PUBLIC" == "null" || -z "$SIGNING_SECRET" || "$SIGNING_SECRET" == "null" ]]; then
  echo "failed to read signing keys from $USERNAME_KEYS" >&2
  exit 1
fi

if [[ ! -f "$DEVICE_SECRET" ]]; then
  "${MULTITOOL[@]}" device new-secret --out "$DEVICE_SECRET"
fi

if [[ ! -f "$DEVICE_CHAIN" ]]; then
  "${MULTITOOL[@]}" device chain-init --root-secret "$DEVICE_SECRET" --out "$DEVICE_CHAIN"
fi

ROOT_HASH="$("${MULTITOOL[@]}" device chain-dump --chain "$DEVICE_CHAIN" | jq -r '.[0].pk_hash')"

if [[ -z "$ROOT_HASH" || "$ROOT_HASH" == "null" ]]; then
  echo "failed to extract root hash from $DEVICE_CHAIN" >&2
  exit 1
fi

"${MULTITOOL[@]}" "${DIR_ARGS[@]}" dir username-add-owner "$USERNAME" \
  --owner "$SIGNING_PUBLIC" \
  --secret-key "$SIGNING_SECRET"

"${MULTITOOL[@]}" "${DIR_ARGS[@]}" dir username-insert "$USERNAME" "$SERVER_NAME" \
  --roothash "$ROOT_HASH" \
  --secret-key "$SIGNING_SECRET"

"${MULTITOOL[@]}" "${DIR_ARGS[@]}" device auth "$USERNAME" \
  --chain "$DEVICE_CHAIN"
