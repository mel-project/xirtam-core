#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

DIR_ENDPOINT="http://127.0.0.1:4000"
DIR_PUBLIC_KEY="OnF3Jh7tZ4o3g3bmUdgjTDa4qlMHN-2Q4RrJQD6K124"
DEFAULT_USERNAME="@demo01"
CHAIN_FILE="$ROOT/demo/state/device-chain.bcs"

if [[ $# -lt 1 ]]; then
  echo "usage: $(basename "$0") [@username] <message...>" >&2
  exit 1
fi

USERNAME="$DEFAULT_USERNAME"
if [[ "$1" == @* ]]; then
  USERNAME="$1"
  shift
fi

MESSAGE="$*"

cd "$ROOT"

if [[ ! -f "$CHAIN_FILE" ]]; then
  echo "missing chain file: $CHAIN_FILE (run demo/register-demo-username-device first)" >&2
  exit 1
fi

exec cargo run -p nullspace-multitool -- \
  --endpoint "$DIR_ENDPOINT" \
  --public-key "$DIR_PUBLIC_KEY" \
  device mailbox-send "$USERNAME" \
  --chain "$CHAIN_FILE" \
  "$MESSAGE"
